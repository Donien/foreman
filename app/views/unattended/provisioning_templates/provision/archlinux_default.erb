<%#
kind: provision
name: Arch Linux default
model: ProvisioningTemplate
oses:
- Archlinux
test_on:
- host4dhcp
- host6dhcp
- host4and6dhcp
- host4static
- host6static
description: |
  The provisioning template for Arch Linux.
  To customize the installation, modify the host parameters.

  This template accepts the following parameters:
  - lang: string (default="en_US.UTF-8")
  - keyboard: string (default="us")
  - additional-packages: string (default=undef)
  - lukspass: string (default=@host.name)
-%>
<%
packages     = [ 'vim', 'openssh' ]
lang         = host_param('lang') || 'en_US.UTF-8'
keyboard     = host_param('keyboard') || 'us'
sys_language = lang.split('.')[0]
sys_encoding = lang.split('.')[1]
lukspass     = host_param('lukspass') || @host.name
ptable_hash  = parse_json(@host.diskLayout)
%>


# Get the very first disk (lsblk) and replace the variable '$disk' in the json strings
disk="$(lsblk --nodeps --paths --output NAME,TYPE | grep disk | cut -d ' ' -f 1 | head -1)"

# Read in disk layout
cat << EOF > user_disk_layout.json
<%= to_json(ptable_hash['user_disk_layout']) %>
EOF

<% if ptable_hash.key?('user_configuration') and ptable_hash['user_configuration'].key?('disk_encryption') %>
cat << EOF > user_credentials.json
{
    "encryption_password": "<%= lukspass %>"
}
EOF
<% end %>



# The actual install settings
cat << EOF > user_configuration.json
{
    "config_version": "2.5.5",
    "debug": false,
    <%- if ptable_hash.key?('user_configuration') and ptable_hash['user_configuration'].key?('disk_encryption') -%>
    "disk_encryption": <%= to_json(ptable_hash['user_configuration']['disk_encryption']) %>,
    <%- end -%>
    "harddrives": [
        "$disk"
    ],
    "hostname": "<%= @host.name -%>",
    "keyboard-layout": "<%= keyboard -%>",
    "bootloader": "grub-install",
    "profile": {
	"path": "/usr/lib/python3.10/site-packages/archinstall/profiles/minimal.py"
    },
    "nic": {
        "dhcp": true,
        "dns": null,
        "gateway": null,
        "iface": null,
        "ip": null,
        "type": "nm"
    },
    "no_pkg_lookups": false,
    "packages": <%= packages -%>,
    "offline": false,
    "script": "guided",
    "silent": false,
    "sys-encoding": "<%= sys_encoding -%>",
    "sys-language": "<%= sys_language -%>",
    "version": "2.5.5"
}
EOF

# Actual install
archinstall --silent --config user_configuration.json --disk_layouts user_disk_layout.json <% if ptable_hash.key?('user_configuration') and ptable_hash['user_configuration'].key?('disk_encryption') %> --creds user_credentials.json <% end %>

# Access to root account (passwords are not well implemented yet)
arch-chroot /mnt/archinstall usermod -p '<%= root_pass %>' root

# SSH (EOW = End Of Wrapper since EOF is used in the snippet)
arch-chroot /mnt/archinstall systemctl enable sshd.service
cat << 'EOW' > deploy_ssh_keys.sh
<%= snippet('remote_execution_ssh_keys') %>
EOW
arch-chroot /mnt/archinstall /bin/bash < deploy_ssh_keys.sh

# DONE - Let Foreman know and reboot
<%= indent(2, skip1: true) { snippet('built', :variables => { :endpoint => 'built', :method => 'POST' }) } -%>
reboot
